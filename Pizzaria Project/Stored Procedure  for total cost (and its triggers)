CREATE OR REPLACE FUNCTION CUSTOTOTAL()
RETURNS TRIGGER AS $CUSTOTOTAL$
DECLARE 
    PIZZATOTAL FLOAT;                     
    ACOMPANHAMENTOTOTAL FLOAT;             
    TOTAL FLOAT;                         
    CUSTOANIMACAO FLOAT;             
    DURACAOANIMACAO INTEGER; 
    QUANTIDADEACOMPANHAMENTO INTEGER;
    CUSTOACOMPANHAMENTO FLOAT;
    PRECO_ING_EXTRA FLOAT;
    TOTALPEDIDOESP INTEGER;
    PRECO_TOTAL_ING_EXTRA FLOAT;

BEGIN
    PIZZATOTAL:= 0;
    ACOMPANHAMENTOTOTAL := 0;
    CUSTOANIMACAO := 0;
    QUANTIDADEACOMPANHAMENTO := 0;
    CUSTOACOMPANHAMENTO := 0;
    TOTAL := 0;
    PRECO_ING_EXTRA := 0;
    TOTALPEDIDOESP := 0;
    PRECO_TOTAL_ING_EXTRA := 0;
    
    --TESTAR SE PEDIDO COM ENTRETENIMENTO
    SELECT COUNT(PEDIDO_ESPECIAL.IDENT) INTO TOTALPEDIDOESP
    FROM PEDIDO_ESPECIAL
    WHERE PEDIDO_ESPECIAL.IDENT = NEW.IDENT;
    
    IF (TOTALPEDIDOESP = 1)
    --CALCULA O PRECO DA ANIMACAO CASO SEJA PEDIDO ESPECIAL
    THEN 
        SELECT (ANIMADOR.PRECO * ((CAST(PEDIDO_ESPECIAL.DURACAO AS INTEGER))/30))     
INTO CUSTOANIMACAO
        FROM ANIMADOR INNER JOIN PEDIDO_ESPECIAL 
                                                             ON (PEDIDO_ESPECIAL.CPF_ANIMADOR = ANIMADOR.CPF)
        WHERE PEDIDO_ESPECIAL.IDENT = NEW.IDENT;
    END IF;
    
    --CALCULA O PRECO TOTAL DOS ACOMPANHAMENTOS 
    SELECT SUM(PEDIDO_ACOMPANHAMENTO.QUANT * ACOMPANHAMENTO.PRECO)
                 INTO ACOMPANHAMENTOTOTAL
    FROM ACOMPANHAMENTO, PEDIDO_ACOMPANHAMENTO, PEDIDO_NORMAL
    WHERE ACOMPANHAMENTO.COD = PEDIDO_ACOMPANHAMENTO.COD AND
        PEDIDO_NORMAL.IDENT = PEDIDO_ACOMPANHAMENTO.IDENT AND
        ACOMPANHAMENTO.NOME_PIZZARIA = PEDIDO_ACOMPANHAMENTO.NOME_PIZZARIA AND  
        PEDIDO_ACOMPANHAMENTO.IDENT = NEW.IDENT
    GROUP BY PEDIDO_ACOMPANHAMENTO.IDENT;
    
    --CALCULA O PREÇO TOTAL DAS PIZZAS
    SELECT SUM(PIZZA.PRECO) INTO PIZZATOTAL
    FROM PIZZA INNER JOIN (PIZZA_PEDIDO INNER JOIN PEDIDO_NORMAL 
                                                 ON (PIZZA_PEDIDO.IDENT = PEDIDO_NORMAL.IDENT))
                                                      ON PIZZA_PEDIDO.NOME_PIZZA = PIZZA.NOME_PIZZA         
    WHERE PIZZA_PEDIDO.IDENT = NEW.IDENT;
        
    
    --CALCULA O PREÇO TOTAL DOS EXTRAS
    SELECT SUM(INGREDIENTE_EXTRA.PRECO) INTO PRECO_TOTAL_ING_EXTRA
    FROM INGREDIENTE_EXTRA INNER JOIN (EXTRA_PEDIDO INNER JOIN PIZZA_PEDIDO 
                          ON EXTRA_PEDIDO.IDENT = PIZZA_PEDIDO.IDENT)
                                                                                 ON INGREDIENTE_EXTRA.COD = EXTRA_PEDIDO.COD
    WHERE PIZZA_PEDIDO.IDENT = NEW.IDENT;                                             

    IF(CUSTOANIMACAO = NULL) THEN 
CUSTOANIMACAO :=0;
    END IF;
                                                                     
    IF(ACOMPANHAMENTOTOTAL = NULL) THEN 
ACOMPANHAMENTOTOTAL := 0;
    END IF;
    
    IF(PRECO_TOTAL_ING_EXTRA = NULL) THEN 
PRECO_TOTAL_ING_EXTRA := 0;    
    END IF;
    
    IF(PIZZATOTAL = NULL) THEN 
PIZZATOTAL := 0;
    END IF;
                                                                     
                                                                     
    TOTAL  = CUSTOANIMACAO + ACOMPANHAMENTOTOTAL + PRECO_TOTAL_ING_EXTRA + PIZZATOTAL;                                                                 
    RAISE NOTICE 'CUSTOS COMPUTADOS PARA PEDIDO %: ANIMACAO = %, ACOMPANHAMENTO = %, EXTRA = %, PIZZA = %', NEW.IDENT, CUSTOANIMACAO, ACOMPANHAMENTOTOTAL, PRECO_TOTAL_ING_EXTRA, PIZZATOTAL;

    UPDATE PEDIDO_NORMAL SET CUSTO_TOTAL = TOTAL WHERE PEDIDO_NORMAL.IDENT = NEW.IDENT;
                                                     
    RETURN NEW;
END;
$CUSTOTOTAL$ language 'plpgsql';


CREATE TRIGGER CUSTOTOTAL1
AFTER INSERT OR UPDATE OR DELETE ON pizza_pedido
FOR EACH ROW
EXECUTE PROCEDURE CUSTOTOTAL();

CREATE TRIGGER CUSTOTOTAL2
AFTER INSERT OR UPDATE OR DELETE ON pedido_acompanhamento
FOR EACH ROW
EXECUTE PROCEDURE CUSTOTOTAL();

CREATE TRIGGER CUSTOTOTAL3
AFTER INSERT OR UPDATE OR DELETE ON extra_pedido
FOR EACH ROW
EXECUTE PROCEDURE CUSTOTOTAL();

CREATE TRIGGER CUSTOTOTAL4
AFTER INSERT OR UPDATE OR DELETE ON pedido_especial
FOR EACH ROW
EXECUTE PROCEDURE CUSTOTOTAL();
